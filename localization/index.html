
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Self-Driving Car Competition">
      
      
      
        <meta name="author" content="The Race On Organizing Team">
      
      
      <link rel="shortcut icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>Real-Time Localization using AprilTags on a Raspberry Pi - Race On</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
      <link rel="manifest" href="../manifest.webmanifest" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-155985310-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="red">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#real-time-localization-using-apriltags-on-a-raspberry-pi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Race On" class="md-header-nav__button md-logo" aria-label="Race On">
      
  <img src="../images/logo.png" alt="logo"  style="position:relative; margin-top: 2px; width: auto; height: 1.2rem;" />

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Self-Driving Car Competition
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Real-Time Localization using AprilTags on a Raspberry Pi
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/race-on/workshops/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Race On Tutorials
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Race On" class="md-nav__button md-logo" aria-label="Race On">
      
  <img src="../images/logo.png" alt="logo"  style="position:relative; margin-top: 2px; width: auto; height: 1.2rem;" />

    </a>
    Race On
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/race-on/workshops/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Race On Tutorials
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../rules/" class="md-nav__link">
      Rules
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../projects/" class="md-nav__link">
      Projects
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../constitution/" class="md-nav__link">
      Constitution
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../registration/" class="md-nav__link">
      Registration
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" >
    
    <label class="md-nav__link" for="nav-6">
      Workshops
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Workshops" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Workshops
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../workshops/1_ros/" class="md-nav__link">
      1. Introduction to ROS
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../workshops/2_gain_scheduling/" class="md-nav__link">
      2. Gain Scheduling
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../workshops/3_wheel_encoders/" class="md-nav__link">
      3. Wheel encoders
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Real-Time Localization using AprilTags on a Raspberry Pi
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Real-Time Localization using AprilTags on a Raspberry Pi
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-product" class="md-nav__link">
    Final Product
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-requirements" class="md-nav__link">
    System Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youll-need" class="md-nav__link">
    What You'll Need
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up" class="md-nav__link">
    Set-Up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#camera-calibration" class="md-nav__link">
    Camera Calibration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scene-setup" class="md-nav__link">
    Scene Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-images-from-the-raspberry-pi" class="md-nav__link">
    Getting Images from the Raspberry Pi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processing-the-images" class="md-nav__link">
    Processing the Images
  </a>
  
    <nav class="md-nav" aria-label="Processing the Images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raw-data-to-opencv-image" class="md-nav__link">
    Raw Data to OpenCV Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#undistortion" class="md-nav__link">
    Undistortion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apriltag-detection" class="md-nav__link">
    AprilTag Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pose-estimation" class="md-nav__link">
    Pose Estimation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering" class="md-nav__link">
    Filtering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting it all together
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" >
    
    <label class="md-nav__link" for="nav-8">
      Standings
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Standings" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Standings
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../standings/spring-2020/" class="md-nav__link">
      Standings - Spring 2020
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>

  <div id="mailchimp-subscribe-container" class="md-typeset" style="width:200px; margin:80px 0 0 0.5em;">

  <div style="font-size:.64rem">
  <hr/>
  Be first to hear the latest Race On updates
  </div>

  <style type="text/css">
  /* MailChimp Form Embed Code - Horizontal Super Slim - 12/16/2015 v10.7
  Adapted from: http://blog.heyimcat.com/universal-signup-form/ */

  #mc_embed_signup form {padding:10px 0 10px 0;}
  .mc-field-group { display: inline-block; } /* positions input field horizontally */
  #mc_embed_signup input.email {font-family:"Roboto","Open Sans","Helvetica Neue",Arial,Helvetica,Verdana,sans-serif; font-size: 15px; border: 1px solid #000;  -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; color: #000; background-color: #fff; box-sizing:border-box; height:32px; padding: 0px 0.4em; display: inline-block; margin: 5px 0; width:200px; vertical-align:top;}
  #mc_embed_signup label {display:block; font-size:16px; padding-bottom:10px; font-weight:bold;}
  #mc_embed_signup .clear {padding: 0.5em 0; display: block;} /* positions button horizontally in line with input */
  #mc_embed_signup .button {font-size: 13px; border: none; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; letter-spacing: .03em; color: #fff; background-color: #000; box-sizing:border-box; height:32px; line-height:32px; padding:0 18px; display: inline-block; margin: 0; transition: all 0.23s ease-in-out 0s;}
  #mc_embed_signup .button:hover {background-color:rgba(245, 22, 65, 0.894); cursor:pointer;}
  #mc_embed_signup div#mce-responses {float:left; top:-1.4em; padding:0em .5em 0em .5em; overflow:hidden; width:90%;margin: 0 5%; clear: both;}
  #mc_embed_signup div.response {margin:1em 0; padding:1em .5em .5em 0; font-weight:bold; float:left; top:-1.5em; z-index:1; width:80%;}
  #mc_embed_signup #mce-error-response {display:none;}
  #mc_embed_signup #mce-success-response {color:#529214; display:none;}
  #mc_embed_signup label.error {display:block; float:none; width:auto; margin-left:1.05em; text-align:left; padding:.5em 0;}
  @media (max-width: 768px) {
      #mc_embed_signup input.email {width:100%; margin-bottom:5px;}
      #mc_embed_signup .clear {padding 0.5em 0;}
      #mc_embed_signup .button {width: 100%; margin:0; }
  }
  #mc_embed_signup{background:#fff; clear:left; font:14px "Roboto",Helvetica,Arial,sans-serif; width:100%;}
  </style>
  <div id="mc_embed_signup">
  <form action="https://raceon.us4.list-manage.com/subscribe/post?u=7b136ad752889f814039d5cc9&amp;id=4457808152" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
  <div id="mc_embed_signup_scroll">
      <input type="text" value="" name="FNAME" class="email" id="mce-FNAME" placeholder="first name" required>
      <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
  <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
  <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_7b136ad752889f814039d5cc9_4457808152" tabindex="-1" value=""><input type="text" name="group[67013][4]" value="4"></div>
  <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
  </div>
  </form>
  </div>
  </div>

</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-product" class="md-nav__link">
    Final Product
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-requirements" class="md-nav__link">
    System Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youll-need" class="md-nav__link">
    What You'll Need
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up" class="md-nav__link">
    Set-Up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#camera-calibration" class="md-nav__link">
    Camera Calibration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scene-setup" class="md-nav__link">
    Scene Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-images-from-the-raspberry-pi" class="md-nav__link">
    Getting Images from the Raspberry Pi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processing-the-images" class="md-nav__link">
    Processing the Images
  </a>
  
    <nav class="md-nav" aria-label="Processing the Images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raw-data-to-opencv-image" class="md-nav__link">
    Raw Data to OpenCV Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#undistortion" class="md-nav__link">
    Undistortion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apriltag-detection" class="md-nav__link">
    AprilTag Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pose-estimation" class="md-nav__link">
    Pose Estimation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering" class="md-nav__link">
    Filtering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting it all together
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="real-time-localization-using-apriltags-on-a-raspberry-pi">Real-Time Localization using AprilTags on a Raspberry Pi<a class="headerlink" href="#real-time-localization-using-apriltags-on-a-raspberry-pi" title="Permanent link">&para;</a></h1>
<p>Date: September 4, 2020 <br>
Author: Theodore Lewitt <br></p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>This article describes the work I did for the Race On RC self-driving car competition at USC. This code will be used by future competitors for car localization on the track! <br>
I will show you how to set-up both the hardware and software used on this project. I will also explain the reasoning behind each part of the main algorithm and how to make it run at 30+ FPS.</p>
<h2 id="final-product">Final Product<a class="headerlink" href="#final-product" title="Permanent link">&para;</a></h2>
<p>ADD VIDEO</p>
<h2 id="system-requirements">System Requirements<a class="headerlink" href="#system-requirements" title="Permanent link">&para;</a></h2>
<p>For each frame the camera sends to the Raspberry Pi, we need to process the data quickly enough to run in real time. For more concrete requirements, we can look at the servo motor on the car which can only update at 50 Hz. So we don't need anything faster than 50 FPS but will need greater than 20 FPS otherwise the car can travel too far in between updates.</p>
<p>The other requirement is high localization accuracy so our car never is disqualified for going off the track. The white boundaries of the Race On track are 2 inches thick, so we ideally want accuracy up to 2 inches so our car can hug the track around the turns for the fastest time. However, most teams take a more conservative approach and we will require less than 5 inch error.</p>
<ul>
<li>FPS: 20 - 50, ideally &gt;40</li>
<li>Max Localization Error: 5 inches (12.7 cm)</li>
</ul>
<h2 id="what-youll-need">What You'll Need<a class="headerlink" href="#what-youll-need" title="Permanent link">&para;</a></h2>
<ul>
<li>Printed AprilTags, download [here] (https://github.com/AprilRobotics/apriltag-imgs/tree/master/tagStandard41h12), resize to 6 inches by 6 inches using software like <a href="https://www.gimp.org/downloads/">GIMP</a>, and print!</li>
<li>Printed Checkerboard for camera calibration, download <a href="https://markhedleyjones.com/storage/checkerboards/Checkerboard-A4-30mm-8x6.pdf">here</a> and print!</li>
<li><a href="https://www.seeedstudio.com/Raspberry-Pi-Wide-Angle-Camera-Module.html">Raspberry Pi Wide Angle Camera Module</a> </li>
</ul>
<h2 id="set-up">Set-Up<a class="headerlink" href="#set-up" title="Permanent link">&para;</a></h2>
<ul>
<li>Install OpenCV on the Pi following this <a href="https://www.pyimagesearch.com/2019/09/16/install-opencv-4-on-raspberry-pi-4-and-raspbian-buster/">guide</a></li>
<li>Clone this <a href="https://github.com/teddylew12/race_on_cv">repo</a> and install other dependencies using <code>pip install -r requirements.txt</code></li>
<li>Measure the size of your AprilTags in meters. ADD PHOTO HERE</li>
</ul>
<h2 id="camera-calibration">Camera Calibration<a class="headerlink" href="#camera-calibration" title="Permanent link">&para;</a></h2>
<p>Before we start using the AprilTags for localization, we need some more information about the camera. The Wide Angle Camera Module is a fisheye camera with 160 degrees of view, compared to 80–90 degrees on a normal camera. The trade-off with an fisheye camera is straight lines become curves near the edges of the image. ADD PHOTO</p>
<p>We preform camera calibration to understand where a point in 3D space maps to the 2D pixel coordinates in the image. The output of the camera calibration is  the intrinsic matrix <em>K</em> and the distortion array <em>D</em>. To learn some of the theory behind camera calibration and what <em>K</em> means, check out this <a href="http://ksimek.github.io/2013/08/13/intrinsic/">blog</a>. 
OpenCV has the fisheye calibration module, which finds both <em>K</em> and <em>D</em> from a set of images of a checkerboard. Use the <em>fisheye_calibration.py</em> script to obtain <em>K</em> and <em>D</em>.</p>
<h2 id="scene-setup">Scene Setup<a class="headerlink" href="#scene-setup" title="Permanent link">&para;</a></h2>
<p>This is the final step before diving into the actual code, we need to place the printed AprilTags on a flat surface (wall, floor, ceiling,…).</p>
<ol>
<li>Determine a global coordinate frame origin, ideally the bottom left corner of the room as it will make the following steps easier and keep all the numbers positive. From this point, we will use positive X to the right, positive Y going up and positive Z going out of the wall towards you. <br></li>
<li>Place AprilTags around the room, in pairs of 2 or 3. The detections start failing from farther than 3 meters. Make sure the tag is not rotated or upside down, using a visualization script like <a href="https://github.com/teddylew12/race_on_cv/blob/master/visualize_frame.py">visualize_frame.py</a>. <br></li>
<li>Measure the position of the tags, in inches from your global origin.<br></li>
<li>Determine the orientation of the tags in reference to your global coordinate system in terms of Euler angles. Euler angles are a way to describe rotations in 3D and consist of 3 angles; X, Y and Z. To read more about Euler angles, I'd recommend this <a href="http://www.chrobotics.com/library/understanding-euler-angles">article</a>. If your tag is on a wall, the only angle that will change is the Y angle. If your tag is on a floor or ceiling, the only angle that will change is the X angle. <br></li>
<li>Save all of these measurements using the add_tag() function from <a href="https://github.com/teddylew12/race_on_cv/blob/master/tag.py">tag.py</a>, which takes the tag id, coordinates (in inches) and Euler angles (in radians). This function will automatically convert inches to meters for you.</li>
</ol>
<h2 id="getting-images-from-the-raspberry-pi">Getting Images from the Raspberry Pi<a class="headerlink" href="#getting-images-from-the-raspberry-pi" title="Permanent link">&para;</a></h2>
<p>The PiCamera module provides many ways to capture frames from the camera, but many don't provide enough FPS for our use case.  For example, the <a href="https://picamera.readthedocs.io/en/release-1.13/api_camera.html#picamera.PiCamera.capture_continuous">capture_continuous</a> function allows us to rapidly capture individual frames, but is limited to 20–30 FPS. Instead we record a video, and write to a custom class that can get up to 90 FPS. <br>
Our custom class, called Stream, is where all of the image processing and AprilTag detection takes place. This happens inside the main function write(), which receives raw YUV camera data from camera.start_recording() function.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>#Inside real_time.py
with PiCamera() as camera:
  stream = Stream()
  try:
    # Start recording frames to the stream object
    camera.start_recording(stream, format=&#39;yuv&#39;)
    t0 = time()

    while True:
      camera.wait_recording()
      # If the time limit is reached, end the recording
      if (time() - t0) &gt; MAX_TIME:
          camera.stop_recording()
          break
</code></pre></div>
</td></tr></table></p>
<h2 id="processing-the-images">Processing the Images<a class="headerlink" href="#processing-the-images" title="Permanent link">&para;</a></h2>
<p>The majority of the processing is within the <em>write()</em> function of the Stream class.  There are 5 main steps that take an raw camera image to an measurement of the camera's location.
1. Raw Data to OpenCV Image
2. Undisortion
3. AprilTag Detection
4. Pose Estimation
5. Filtering</p>
<h3 id="raw-data-to-opencv-image">Raw Data to OpenCV Image<a class="headerlink" href="#raw-data-to-opencv-image" title="Permanent link">&para;</a></h3>
<p>AprilTags detect on grayscale images, so instead of capturing a RGB image and converting to grayscale, we capture a YUV image. An YUV image is composed of three channels: luminance(Y), chroma blue (U), chroma red (V). The Y channel corresponds to a grayscale image, so when the camera writes to the stream, we only need to read in the first channel of the image to get the grayscale. OpenCV represents it's images as numpy arrays in Python. We use np.frombuffer() to read the bytes into a numpy array.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code># Within stream.py, data is the raw bytes from the camera
res = (640,480)
I_raw = np.frombuffer(data, dtype=np.uint8, count=res[1]*res[0])
I_raw = I_raw.reshape(res[1], res[0])
</code></pre></div>
</td></tr></table></p>
<h3 id="undistortion">Undistortion<a class="headerlink" href="#undistortion" title="Permanent link">&para;</a></h3>
<p>Once we have the raw image, we need to apply un-distortion to our image to reverse all of the fisheye distortion before detecting AprilTags. Un-distortion has two steps, one that can be pre-calculated and one that needs to be performed on each frame. <br>
The pre-calculated step is computing a rectification and un-distortion matrices using cv2.fisheye.initUndistortRectifyMap(). These matrices are inputted into the cv2.remap() function, which needs to be called on each frame and outputs the corrected image. <br></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>### In real_time.py
# K and D are camera intrinsics from the Camera Calibration
# Res is the resolution of the image
map_1, map_2 = cv2.fisheye.initUndistortRectifyMap(K, D, np.eye(3), K, res, cv2.CV_16SC2)

### In stream.py
I = cv2.remap(I_raw, map_1, map_2)
</code></pre></div>
</td></tr></table>
<h3 id="apriltag-detection">AprilTag Detection<a class="headerlink" href="#apriltag-detection" title="Permanent link">&para;</a></h3>
<p>To use the python AprilTags bindings from this repo, you first create a Detector object. There are a bunch of different arguments for creating a Detector, and I'll highlight the most important ones.
- Families: The families of AprilTags it should look for, we use tagStandard41h12.
- nthreads: Number of threads to use for detection, using more will speed up detections.
- quad-decimate: Uses a lower resolution image for detection, improving speed but reducing accuracy/pose estimation. Defaults to 1.0 but I'd recommend a value between 2.0 and 4.0 for optimal tradeoff.
- debug: Defaults to 0 but if set to 1 will save images from each step in the detection process. Very computationally expensive, should only be used on single frames.</p>
<p>To use the Detector, we call the detect() function on a image. For pose estimation, we set estimate_tag_pose to True and supply the tag size and four elements from the camera's K matrix. </p>
<p>The output of the detect() functions is a list of Detection objects. Each Detection contains a lot of information about the tag it detected and I'll highlight the important ones.
Tag_ID: The ID of the Tag
Corners: A list of 4 tuples containing the pixel coordinates of the corners. These wrap counter clockwise from the bottom left corner.
Pose_R: A 3x3 Rotation matrix of the tag in the camera frame
Pose_T: A 3x1 Translation vector of the tag in the camera frame</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>### In real_time.py
detector = Detector(families=&quot;tagStandard41h12&quot;,nthreads=4)

### In stream.py
PARAMS = [K[0,0],K[1,1],K[2,0],K[2,1]] #elements from the K matrix
TAG_SIZE = .10 #Tag size from Step 1 in meters 
detections = detector.detect(I, estimate_tag_pose=True, camera_params=PARAMS,tag_size=TAG_SIZE)
</code></pre></div>
</td></tr></table>
<h3 id="pose-estimation">Pose Estimation<a class="headerlink" href="#pose-estimation" title="Permanent link">&para;</a></h3>
<p>We now have all of the information we need to estimate the position of the camera. What we want is the position of the camera in the global frame, and we can break that into two steps. We get the location of the camera in the tag frame and combine with the location of the tag in the global frame.</p>
<p>First, we need the rotation matrix <em>R</em> and translation vector <em>t</em> of the camera in the tag frame. We can get these by inverting the Pose_R and Pose_T we get from the Apriltags. R is an orthogonal rotation matrix, meaning the inverse is the same as the transpose. t is a translation vector, so its inverse just negates everything.</p>
<p><span class="arithmatex">\(R_camera_tag = Pose_R^{T}\)</span>
<span class="arithmatex">\(t_camera_tag = -1 * Pose_t\)</span></p>
<p>To get the exact location of the camera in the tag frame, we start with the tag center in the tag frame, translate by <em>t_camera_tag</em> and multiply by <em>R_camera_tag</em>. But the tag center in the tag frame is (0,0,0) so our final equation is
<span class="arithmatex">\(Position_tag = R_camera_tag * t_camera_tag\)</span></p>
<p>The next step is a correction between the official tag frame on the AprilTags website and the tag frame that I chose to use. My reasoning for choosing to use a slightly different tag frame is that my tag frame aligns with the global frame if all the Euler angles are 0 which helps me visualize the global transformations. The official AprilTags tag frame has the z-axis pointing from the tag center into the wall. The x-axis is to the right in the image taken by the camera, and y is down. This means to transform to our global frame with X right, Y up and Z out of the wall we need X-&gt;X,Y-&gt;-Y and Z-&gt;-Z. We can use a 3x3 diagonal permutation matrix <em>P</em> to model this, with either 1 or -1 on the diagonal elements. ADD PHOTO</p>
<p><span class="arithmatex">\(Position_tag_unofficial = P * Position_tag\)</span></p>
<p>Now we go from the tag frame to the global frame using the information from the look-up table we populated when doing the scene setup. We have our global rotation matrix <span class="arithmatex">\(R_{g}\)</span> and global translation vector <span class="arithmatex">\(t_{g}\)</span>.</p>
<p><span class="arithmatex">\(Position_global = R_{g} * Position_tag_unofficial + t_{g}\)</span></p>
<p>In Python, we can use the matrix mulptiplcation symbol @ introduced in 3.6. Combining all of the transformations becomes
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>unofficial_tag_position = P @ Pose_R.T @ (-1 * Pose_T)
global_position = R_g @ unofficial_tag_position + t_g
</code></pre></div>
</td></tr></table>
If there are multiple tags in a single frame, we estimate the position using all the tags, and then average the estimates.</p>
<h3 id="filtering">Filtering<a class="headerlink" href="#filtering" title="Permanent link">&para;</a></h3>
<p>We now have a pose estimate of the camera position, but how accurate is this measurement? In my work, I've found the Apriltags are accurate to &plusmn; 10 cm when viewed close to straight on and from closer than 2 meters. We do have a lot more information we can use to improve these measurements. <br>
First, we can assume the camera won't move too drastically between frames, so we can use a moving average to smooth out some of the noise from frame to frame. The parameter choice here is how many time steps to average, with more time steps resulting in a more smooth trajectory over time. <br>
Now, with a little more information about where our camera should be, for example if we know the inputs to our self-driving car's motor at the previous frame, we can use a g-h filter or a Kalman filter to further improve our position accuracy. There is a lifetime of really interesting work in this field and one of the best intro books I've read is <a href="https://github.com/rlabbe/Kalman-and-Bayesian-Filters-in-Python">here</a>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>pose = moving_average(global_position,previous_positions,num_time_steps)
</code></pre></div>
</td></tr></table>
<h2 id="putting-it-all-together">Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permanent link">&para;</a></h2>
<p>Here is psuedocode for real_time.py
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>#Camera Calibration Parameters
camera_info = load_camera_information()

#Scene Setup
tags=Tag()
tags.add_tag(tag_id,x,y,z,theta_x,theta_y,theta_z)

### Detector
detector = Detector(families=&quot;tagStandard41h12&quot;,nthreads=4)
#Main Loop
with PiCamera() as camera:
  stream = Stream(tags,camera_info,detector)
  try:
    # Start recording frames to the stream object
    camera.start_recording(stream, format=&#39;yuv&#39;)
    t0 = time()

    while True:
      camera.wait_recording()
      # If the time limit is reached, end the recording
      if (time() - t0) &gt; MAX_TIME:
          camera.stop_recording()
          break
</code></pre></div>
</td></tr></table>
Psuedocode for stream.py
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>def write(raw_bytes):
  I_raw = np.frombuffer(raw_bytes)
  I = undistort(I_raw)
  detected_tags = detector.detect(I)
  raw_position_estimate = estimate_pose(detected_tags)
  smoothed_position = moving_average(raw_position_estimate)
</code></pre></div>
</td></tr></table></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../workshops/3_wheel_encoders/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                3. Wheel encoders
              </div>
            </div>
          </a>
        
        
          <a href="../standings/spring-2020/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Standings - Spring 2020
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 The Race On organizing team
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="../javascripts/tables.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/arithmatex.js"></script>
      
    
  </body>
</html>